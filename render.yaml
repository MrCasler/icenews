# Render.com deployment configuration for ICENews
# Includes self-hosted Umami analytics

services:
  # Main ICENews web app
  # Python version: set PYTHON_VERSION env (e.g. 3.11.0) or add .python-version in repo
  - type: web
    name: icenews
    runtime: python
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn app.main:app --host 0.0.0.0 --port $PORT
    plan: free
    envVars:
      # Basic auth (leave empty to disable)
      - key: ICENEWS_AUTH_EMAIL
        sync: false
      - key: ICENEWS_AUTH_PASSWORD
        sync: false
      
      # Scrapfly API keys
      - key: SCRAPFLY_KEY
        sync: false
      - key: SCRAPFLY_LIVE_KEY
        sync: false
      - key: SCRAPFLY_TEST_KEY
        sync: false
      - key: SCRAPFLY_USE_TEST
        value: "0"
      
      # Ingestion settings
      - key: ICENEWS_MAX_TWEETS_PER_ACCOUNT
        value: "4"
      
      # Session cookie: set to .icenews.eu so login works on both www and non-www
      - key: COOKIE_DOMAIN
        sync: false
      # Umami Analytics (self-hosted)
      - key: UMAMI_WEBSITE_ID
        sync: false
      - key: UMAMI_SCRIPT_URL
        value: https://icenews-umami.onrender.com/script.js

  # Self-hosted Umami analytics
  - type: web
    name: icenews-umami
    runtime: docker
    repo: https://github.com/umami-software/umami.git
    branch: master
    plan: free
    envVars:
      - key: DATABASE_TYPE
        value: postgresql
      - key: DATABASE_URL
        fromDatabase:
          name: icenews-umami-db
          property: connectionString
      - key: HASH_SALT
        generateValue: true

databases:
  # PostgreSQL database for Umami analytics
  - name: icenews-umami-db
    plan: free
    databaseName: icenews_umami
    user: icenews_umami
